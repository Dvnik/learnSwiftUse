# ç¬¬ 18 ç«  ä½¿ç”¨ SwiftUI æ‰‹å‹¢èˆ‡ GeometryReader å»ºç«‹å±•é–‹å¼åº•éƒ¨è¡¨

Class: ç²¾é€šSwiftUI
Created: December 26, 2022 9:35 AM
Reviewed: No
Type: SwiftUI4

# å‰è¨€

å› ç‚ºã€Œåº•éƒ¨è¡¨ã€ï¼ˆbottom sheet ï¼‰è¶Šä¾†è¶Šå—æ­¡è¿ï¼Œæ‰€ä»¥æœ¬ç« çš„ç¯„ä¾‹ä»¥é€™å€‹åšç‚ºä¾‹å­ã€‚

# ****èµ·å§‹å°ˆæ¡ˆ****

<aside>
ğŸ’¡ ç¯„ä¾‹çš„å°ˆæ¡ˆåç¨±ï¼š`SwiftUIBottomSheet` ã€‚ä¸»é¡Œæ˜¯é¤å»³åˆ—è¡¨è³‡è¨Šã€‚

</aside>

`Restaurant.swift`çµæ§‹ï¼š

```swift
struct Restaurant: Identifiable {
    var id: UUID = UUID()
    var name: String
    var type: String
    var location: String
    var phone: String
    var description: String
    var image: String
    var isVisited: Bool

    init(name: String, type: String, location: String, phone: String, description: String, image: String, isVisited: Bool) {
        self.name = name
        self.type = type
        self.location = location
        self.phone = phone
        self.description = description
        self.image = image
        self.isVisited = isVisited
    }

    init() {
        self.init(name: "", type: "", location: "", phone: "", description: "", image: "", isVisited: false)
    }
}
```

<aside>
ğŸ’¡ ç¯„ä¾‹ä¸­å·²ç¶“å…ˆå¯«å¥½ä¸€æ‰¹è³‡æ–™ï¼Œä¸¦å‘½åç‚º`restaurants: [Restaurant]`çš„è®Šæ•¸ã€‚

</aside>

# ****å»ºç«‹é¤å»³ç´°ç¯€è¦–åœ–****

ç´°ç¯€è¦–åœ–çš„ä½ˆå±€æœ‰é»è¤‡é›œï¼Œå› æ­¤æœ€å¥½å°‡å…¶åˆ†æˆå¹¾å€‹éƒ¨åˆ†ï¼Œä»¥æ›´å®¹æ˜“å¯¦ä½œï¼š

- ã€Œæ©«åˆ—ã€æ˜¯ä¸€å€‹å°åœ“è§’çŸ©å½¢ã€‚
- æ¨™é¡Œåˆ—åŒ…å«ç´°ç¯€è¦–åœ–çš„æ¨™é¡Œã€‚
- é ­éƒ¨è¦–åœ–åŒ…å«é¤å»³ç‰¹è‰²åœ–ç‰‡ã€é¤å»³åç¨±èˆ‡é¤å»³é¡å‹ã€‚
- ç´°ç¯€è³‡è¨Šè¦–åœ–åŒ…å«é¤å»³è³‡æ–™ï¼Œå…¶ä¸­æœ‰åœ°å€ã€é›»è©±èˆ‡æè¿°ã€‚

æˆ‘å€‘å°‡ä½¿ç”¨å–®ç¨çš„ çµæ§‹ï¼ˆstruct ï¼‰ä¾†å¯¦ä½œä¸Šè¿°æ¯å€‹éƒ¨åˆ†ï¼Œä»¥è®“ç¨‹å¼ç¢¼æ›´æ˜“ç·¨å¯«ã€‚ç¾åœ¨ä½¿ç”¨ã€ŒSwiftUI Viewã€æ¨¡æ¿å»ºç«‹ä¸€å€‹æ–°æª”æ¡ˆï¼Œä¸¦å‘½åç‚º`RestaurantDetailView.swift`ã€‚ä¸‹é¢è¨è«–çš„æ‰€æœ‰ç¨‹å¼ç¢¼éƒ½å°‡æ”¾åˆ°é€™å€‹æ–°æª”æ¡ˆä¸­ã€‚

## ****æ©«åˆ—****

é¦–å…ˆæ˜¯ã€Œæ©«åˆ—ã€ï¼ˆhandlebar ï¼‰ï¼Œå®ƒå¯¦éš›ä¸Šæ˜¯ä¸€å€‹å°åœ“è§’çŸ©å½¢ã€‚è¦å»ºç«‹å®ƒï¼Œæˆ‘å€‘éœ€è¦åšçš„æ˜¯å»ºç«‹ä¸€å€‹Â `Rectangle`ï¼Œä¸¦ä½¿å…¶è®Šæˆåœ“è§’ã€‚ åœ¨Â `RestaurantDetailView.swift`Â æª”ä¸­æ’å…¥ä¸‹åˆ—çš„ç¨‹å¼ç¢¼ï¼š

```swift

struct HandleBar: View {

    var body: some View {
        Rectangle()
            .frame(width: 50, height: 5)
            .foregroundColor(Color(.systemGray5))
            .cornerRadius(10)
    }
}
```

## ****æ¨™é¡Œåˆ—****

æ¥è‘—æ˜¯ã€Œæ¨™é¡Œåˆ—ã€ï¼ˆtitle bar ï¼‰ï¼Œå¯¦ä½œå¾ˆç°¡å–®ï¼Œå› ç‚ºå®ƒåªæ˜¯ä¸€å€‹æ–‡å­—è¦–åœ–ã€‚æˆ‘å€‘ç‚ºå®ƒå»ºç«‹å¦ä¸€å€‹çµæ§‹ï¼š

```swift
struct TitleBar: View {

    var body: some View {
        HStack {
            Text("Restaurant Details")
                .font(.headline)
                .foregroundColor(.primary)

            Spacer()
        }
        .padding()
    }
}
```

é€™è£¡çš„ã€Œç•™ç™½ã€ï¼ˆSpacer ï¼‰æ˜¯ç”¨ä¾†å°‡æ–‡å­—é å·¦å°é½Šã€‚

## ****é ­éƒ¨è¦–åœ–****

é ­éƒ¨è¦–åœ–ï¼ˆheader view ï¼‰ç”±ä¸€å€‹åœ–ç‰‡è¦–åœ–èˆ‡å…©å€‹æ–‡å­—è¦–åœ–æ‰€çµ„æˆã€‚é€™å…©å€‹æ–‡å­—è¦–åœ–æœƒç–Šåœ¨åœ–ç‰‡è¦–åœ–ä¸Šé¢ã€‚åŒæ¨£çš„ï¼Œæˆ‘å€‘å°‡ä½¿ç”¨å–®ç¨çš„çµæ§‹ä¾†å¯¦ä½œé ­éƒ¨è¦–åœ–ï¼š

```swift
struct HeaderView: View {
    let restaurant: Restaurant

    var body: some View {
        Image(restaurant.image)
            .resizable()
            .scaledToFill()
            .frame(height: 300)
            .clipped()
            .overlay(
                HStack {
                    VStack(alignment: .leading) {
                        Spacer()
                        Text(restaurant.name)
                            .foregroundColor(.white)
                            .font(.system(.largeTitle, design: .rounded))
                            .bold()

                        Text(restaurant.type)
                            .font(.system(.headline, design: .rounded))
                            .padding(5)
                            .foregroundColor(.white)
                            .background(Color.red)
                            .cornerRadius(5)

                    }
                    Spacer()
                }
                .padding()
            )
    }
}
```

ç”±æ–¼æˆ‘å€‘éœ€è¦é¡¯ç¤ºé¤å»³è³‡æ–™ï¼Œå› æ­¤Â `HeaderView`Â å…·æœ‰Â `restaurant`Â å±¬æ€§ã€‚å°æ–¼é€™å€‹ä½ˆå±€ï¼Œæˆ‘å€‘å»ºç«‹ä¸€å€‹åœ–ç‰‡è¦–åœ–ï¼Œä¸¦è¨­å®šå®ƒçš„å…§å®¹æ¨¡å¼ç‚ºÂ `scaleToFill`ï¼Œåœ–ç‰‡é«˜åº¦å›ºå®šç‚ºã€Œ300 é»ã€ã€‚ç”±æ–¼æˆ‘å€‘ä½¿ç”¨Â `scaleToFill`Â æ¨¡å¼ï¼Œæˆ‘å€‘éœ€è¦åŠ ä¸ŠÂ `.clipped()`ä¿®é£¾å™¨ï¼Œä»¥éš±è—è¶…å‡ºåœ–ç‰‡æ¡†é‚Šç·£çš„ä»»ä½•å…§å®¹ã€‚

å°æ–¼é€™å…©å€‹æ¨™ç±¤ï¼Œæˆ‘å€‘ä½¿ç”¨Â `.overlay`Â ä¿®é£¾å™¨ä¾†ç–ŠåŠ å…©å€‹æ–‡å­—è¦–åœ–ã€‚

## ****ç´°ç¯€è³‡è¨Šè¦–åœ–****

åœ°å€èˆ‡é›»è©±æ¬„ä½åœ¨æ–‡å­—è³‡è¨Šæ—éƒ½æœ‰ä¸€å€‹åœ–ç¤ºï¼Œè€Œæè¿°æ¬„ä½å‰‡åªåŒ…å«æ–‡å­—ã€‚

å»ºç«‹ä¸€å€‹èƒ½éˆæ´»è™•ç†å…©ç¨®æ¬„ä½é¡å‹çš„è¦–åœ–ä¸æ˜¯å¾ˆå¥½å—ï¼Ÿä¸‹åˆ—æ˜¯ç¨‹å¼ç¢¼ç‰‡æ®µï¼š

```swift
struct DetailInfoView: View {
    let icon: String?
    let info: String

    var body: some View  {
        HStack {
            if icon != nil {
                Image(systemName: icon!)
                    .padding(.trailing, 10)
            }
            Text(info)
                .font(.system(.body, design: .rounded))

            Spacer()
        }.padding(.horizontal)
    }
}
```

`DetailInfoView`æœ‰å…©å€‹åƒæ•¸ï¼š`icon`Â èˆ‡Â `info`ã€‚`icon`Â åƒæ•¸æ˜¯å¯é¸ç”¨çš„ï¼Œè¡¨ç¤ºå®ƒå¯ä»¥æœ‰å€¼æˆ–æ˜¯ nilã€‚

ç•¶ä½ éœ€è¦é¡¯ç¤ºè³‡æ–™æ¬„ä½åŠåœ–ç¤ºæ™‚ï¼Œä½ å¯ä»¥åƒé€™æ¨£ä½¿ç”¨Â `DetailInfoView`ï¼š

```swift
DetailInfoView(icon: "map", info: self.restaurant.location)
```

å¦å¤–ï¼Œå¦‚æœä½ åªéœ€è¦é¡¯ç¤ºä¸€å€‹æ–‡å­—æ¬„ä½ï¼ˆå¦‚æè¿°æ¬„ä½ï¼‰ï¼Œå‰‡å¯ä»¥åƒé€™æ¨£ä½¿ç”¨Â `DetailInfoView`Â :

```swift
DetailInfoView(icon: nil, info: self.restaurant.description)
```

å¦‚ä½ æ‰€è¦‹ï¼Œé€éå»ºç«‹ä¸€å€‹é€šç”¨è¦–åœ–ä¾†è™•ç†ç›¸ä¼¼çš„ä½ˆå±€ï¼Œå¯ä»¥ä½¿ç¨‹å¼ç¢¼æ›´å…·æ¨¡çµ„åŒ–åŠå¯é‡ç”¨æ€§ã€‚

## ****ä½¿ç”¨ VStack çµ„åˆå…ƒä»¶****

ç¾åœ¨ï¼Œæˆ‘å€‘å·²ç¶“å»ºç«‹äº†æ‰€æœ‰çš„å…ƒä»¶ï¼Œæˆ‘å€‘å¯ä»¥ä½¿ç”¨Â `VStack`Â çµ„åˆå®ƒå€‘ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š

```swift
struct RestaurantDetailView: View {
    let restaurant: Restaurant

    var body: some View {
        VStack {
            Spacer()

            HandleBar()

            TitleBar()

            HeaderView(restaurant: self.restaurant)

            DetailInfoView(icon: "map", info: self.restaurant.location)
                .padding(.top)
            DetailInfoView(icon: "phone", info: self.restaurant.phone)
            DetailInfoView(icon: nil, info: self.restaurant.description)
                .padding(.top)
        }
        .background(Color.white)
        .cornerRadius(10, antialiased: true)
    }
}
```

åœ¨æ¸¬è©¦ç´°ç¯€è¦–åœ–ä¹‹å‰ï¼Œå¿…é ˆä¿®æ”¹Â `RestaurantDetailView_Previews`Â çš„ç¨‹å¼ç¢¼å¦‚ä¸‹ï¼š

```swift
struct RestaurantDetailView_Previews: PreviewProvider {
    static var previews: some View {
        RestaurantDetailView(restaurant: restaurants[0])
    }
}
```

åœ¨ç¨‹å¼ç¢¼ä¸­ï¼Œæˆ‘å€‘å‚³é€ä¸€å€‹ç¯„ä¾‹é¤å»³ï¼ˆå³Â `restaurants[0]`Â ï¼‰é€²è¡Œæ¸¬è©¦ã€‚

## ****ä½¿è¦–åœ–å¯æ»¾å‹•****

ä½ æ˜¯å¦æ³¨æ„åˆ°ç´°ç¯€è¦–åœ–ç„¡æ³•é¡¯ç¤ºå®Œæ•´çš„å…§å®¹å‘¢ï¼Ÿè¦è§£æ±ºé€™å€‹å•é¡Œï¼Œæˆ‘å€‘å¿…é ˆå°‡å…§å®¹åµŒå…¥åœ¨Â `ScrollView`ï¼Œä»¥è®“ç´°ç¯€è¦–åœ–å¯æ»¾å‹•ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š

```swift
struct RestaurantDetailView: View {
    let restaurant: Restaurant

    var body: some View {
        VStack {
            Spacer()

            HandleBar()

            ScrollView(.vertical) {
                TitleBar()

                HeaderView(restaurant: self.restaurant)

                DetailInfoView(icon: "map", info: self.restaurant.location)
                    .padding(.top)
                DetailInfoView(icon: "phone", info: self.restaurant.phone)
                DetailInfoView(icon: nil, info: self.restaurant.description)
                    .padding(.top);
            }
            .background(Color.white)
            .cornerRadius(10, antialiased: true)
        }
    }
}
```

é™¤äº†æ©«åˆ—ä¹‹å¤–ï¼Œå…¶ä»–è¦–åœ–è¢«åŒ…è£¹åœ¨æ»¾å‹•è¦–åœ–ä¸­ã€‚å¦‚æœä½ å†æ¬¡åœ¨é è¦½ç•«å¸ƒä¸­åŸ·è¡ŒAppï¼Œ ç´°ç¯€è¦–åœ–ç¾åœ¨å¯æ»¾å‹•äº†ã€‚

## ****èª¿æ•´åç§»é‡****

åº•éƒ¨è¡¨ç›®å‰ç–Šåœ¨åŸæœ¬å…§å®¹çš„ä¸Šæ–¹ï¼Œä¸éé€šå¸¸åªè¦†è“‹éƒ¨åˆ†å…§å®¹ï¼Œå› æ­¤æˆ‘å€‘å¿…é ˆèª¿æ•´ç´°ç¯€è¦–åœ–çš„åç§»é‡ï¼Œä½¿å®ƒåªè¦†è“‹è¢å¹•çš„ä¸€éƒ¨åˆ†ã€‚ç‚ºæ­¤ï¼Œæˆ‘å€‘å¯ä»¥åƒé€™æ¨£å°‡Â `offset`ä¿®é£¾å™¨åŠ åˆ°Â `VStack`Â ä¸Šï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š

```swift
.offset(y: 300)
```

é€™æœƒå°‡ç´°ç¯€è¦–åœ–å‘ä¸‹ç§»å‹• 300 é»ï¼Œå¦‚æœä½ åœ¨é è¦½ç•«å¸ƒä¸­æ¸¬è©¦ç¨‹å¼ç¢¼ï¼Œå‰‡ç´°ç¯€è¦–åœ–æ‡‰è©²æœƒç§»åˆ°è¢å¹•çš„ä¸‹åŠéƒ¨

è¦ä½¿å®ƒçœ‹èµ·ä¾†æ›´åƒæœ€çµ‚çµæœï¼Œä½ å¯ä»¥è®Šæ›´Â `RestaurantDetailView_Previews`Â çš„èƒŒæ™¯é¡è‰²å¦‚ä¸‹ï¼š

```swift
struct RestaurantDetailView_Previews: PreviewProvider {
    static var previews: some View {
        RestaurantDetailView(restaurant: restaurants[0])
            .background(Color.black.opacity(0.3))
            .edgesIgnoringSafeArea(.all)
    }
}
```

ç´°ç¯€è¦–åœ–ç¾åœ¨çœ‹èµ·ä¾†ä¸éŒ¯ï¼Œä¸éæœ‰å€‹å•é¡Œæ˜¯åç§»é‡è¨­å®šç‚ºå›ºå®šå€¼ã€‚ç”±æ–¼ App å°‡æ”¯æ´å¤šå€‹è£ç½®æˆ–è¢å¹•å¤§å°ï¼Œå› æ­¤åç§»é‡æ‡‰è©²èƒ½å¤ è‡ªå‹•èª¿æ•´ã€‚

åœ¨ SwiftUI ä¸­ï¼Œå®ƒæä¾›ä¸€å€‹åç‚ºã€ŒGeometryReaderã€çš„å®¹å™¨è¦–åœ–ï¼Œå¯ä»¥è®“ä½ å­˜å–çˆ¶è¦–åœ–ï¼ˆparent view ï¼‰çš„å¤§å°èˆ‡ä½ç½®ã€‚å› æ­¤ï¼Œè¦å–å¾—è¢å¹•é«˜åº¦ï¼Œä½ æ‰€éœ€è¦åšçš„æ˜¯ä½¿ç”¨Â `GeometryReader`
Â åŒ…è£¹Â `VStack`ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š

```swift
struct RestaurantDetailView: View {
    let restaurant: Restaurant

    var body: some View {
        GeometryReader { geometry in
            VStack {
                Spacer()

                HandleBar()

                ScrollView(.vertical) {
                    TitleBar()

                    HeaderView(restaurant: self.restaurant)

                    DetailInfoView(icon: "map", info: self.restaurant.location)
                        .padding(.top)
                    DetailInfoView(icon: "phone", info: self.restaurant.phone)
                    DetailInfoView(icon: nil, info: self.restaurant.description)
                        .padding(.top)
                }
                .background(Color.white)
                .cornerRadius(10, antialiased: true)
            }
            .offset(y: geometry.size.height/2)
            .edgesIgnoringSafeArea(.all)
        }
    }
}
```

åœ¨é–‰åŒ…ä¸­ï¼Œæˆ‘å€‘å¯ä»¥ä½¿ç”¨Â `geometry`Â åƒæ•¸ä¾†å­˜å–çˆ¶è¦–åœ–çš„å¤§å°ï¼Œé€™å°±æ˜¯ç‚ºä»€éº¼æˆ‘å€‘è¨­å®šÂ `offset`ä¿®é£¾å™¨å¦‚ä¸‹ï¼š

```swift
.offset(y: geometry.size.height/2)
```

è¦æ­£ç¢ºè¨ˆç®—å…¨è¢å¹•çš„å°ºå¯¸ï¼Œæˆ‘å€‘åŠ å…¥Â `edgesIgnoringSafeArea`ä¿®é£¾å™¨ï¼Œä¸¦è¨­å®šå…¶åƒæ•¸ç‚ºÂ `.all`ï¼Œä»¥å®Œå…¨å¿½ç•¥å®‰å…¨å€åŸŸã€‚

# ****å¸¶å‡ºç´°ç¯€è¦–åœ–****

ç¾åœ¨ï¼Œç´°ç¯€è¦–åœ–å¹¾ä¹å¿«å®Œæˆäº†ã€‚æˆ‘å€‘å›åˆ°æ¸…å–®è¦–åœ–ï¼ˆå³Â `ContentView.swift`Â ï¼‰ï¼Œä»¥åœ¨ä½¿ç”¨è€…é¸æ“‡é¤å»³æ™‚ï¼Œå¸¶å‡ºç´°ç¯€è¦–åœ–ã€‚

åœ¨Â `ContentView`Â çµæ§‹ï¼Œå®£å‘Šå…©å€‹ç‹€æ…‹è®Šæ•¸ï¼š

```swift
@State private var showDetail = false
@State private var selectedRestaurant: Restaurant?
```

`showDetail`è®Šæ•¸æŒ‡ç¤ºæ˜¯å¦é¡¯ç¤ºç´°ç¯€è¦–åœ–ï¼Œè€ŒÂ `selectedRestaurant`Â è®Šæ•¸å„²å­˜ä½¿ç”¨è€…é¸æ“‡çš„é¤å»³ã€‚

å¦‚å‰é¢ç« ç¯€æ‰€å­¸åˆ°çš„ï¼Œä½ å¯ä»¥åŠ ä¸ŠÂ `onTapGesture`Â ä¿®é£¾å™¨ä¾†åµæ¸¬é»æ“Šæ‰‹å‹¢ã€‚å› æ­¤ï¼Œç•¶è­˜åˆ¥åˆ°é»æ“Šï¼Œæˆ‘å€‘å¯ä»¥åˆ‡æ›`showDetail`çš„å€¼ï¼Œä¸¦æ›´æ–°Â `selectedRestaurant`Â çš„å€¼å¦‚ä¸‹ï¼š

```swift
List {
    ForEach(restaurants) { restaurant in
        BasicImageRow(restaurant: restaurant)
            .onTapGesture {
                self.showDetail = true
                self.selectedRestaurant = restaurant
            }
    }
}
```

å¸Œæœ›ç´°ç¯€è¦–åœ–ï¼ˆå³åº•éƒ¨è¡¨ï¼‰ç–Šåœ¨æ¸…å–®è¦–åœ–çš„ä¸Šæ–¹ã€‚ç‚ºæ­¤ï¼Œè¦ä½¿ç”¨Â `ZStack`Â åµŒå…¥å°è¦½è¦–åœ–ã€‚è€Œåœ¨å°è¦½è¦–åœ–çš„æ­£ä¸‹æ–¹ï¼Œæˆ‘å€‘å°‡æª¢æŸ¥ç´°ç¯€è¦–åœ–æ˜¯å¦å·²å•Ÿç”¨ï¼Œä¸¦å°‡å…¶åˆå§‹åŒ–ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š

```swift
var body: some View {
    ZStack {
        NavigationView {
            List {
                ForEach(restaurants) { restaurant in
                    BasicImageRow(restaurant: restaurant)
                        .onTapGesture {
                            self.showDetail = true
                            self.selectedRestaurant = restaurant
                        }
                }
            }
            .listStyle(.plain)

            .navigationBarTitle("Restaurants")
        }

        if showDetail {
            if let selectedRestaurant = selectedRestaurant {
                RestaurantDetailView(restaurant: selectedRestaurant)
                    .transition(.move(edge: .bottom))
            }
        }
    }
}
```

æˆ‘å€‘é‚„åŠ å…¥Â `transition`Â ä¿®é£¾å™¨è‡³ç´°ç¯€è¦–åœ–ï¼Œå¦‚æ­¤å°±å¯ä½¿ç”¨Â `move`Â è½‰å ´é¡å‹ã€‚`selectedRestaurant`Â å±¬æ€§è¢«å®šç¾©ç‚ºå¯é¸å±¬æ€§ï¼Œé€™è¡¨ç¤ºå®ƒå¯ä»¥æœ‰å€¼æˆ–æ˜¯ nilã€‚åœ¨å­˜å–å±¬æ€§å€¼ä¹‹å‰ï¼Œéœ€è¦æª¢æŸ¥Â `selectedRestaurant`Â æ˜¯å¦æœ‰å€¼ï¼Œå› æ­¤ï¼Œæˆ‘å€‘ä½¿ç”¨Â `if let`Â ä¾†é€²è¡Œç¢ºèªï¼ŒåŒæ™‚æé†’ä¸€ä¸‹ï¼Œæ­¤Â `if let`Â é‹ç®—ç¬¦åªæ”¯æ´ iOS 14 ï¼ˆæˆ–ä»¥ä¸Šçš„ï¼‰ç‰ˆæœ¬ã€‚

ç¾åœ¨ï¼Œå¦‚æœåœ¨é è¦½ç•«å¸ƒä¸­åŸ·è¡Œé€™å€‹ Appï¼Œç•¶ä½ é¸æ“‡ä¸€é–“é¤å»³æ™‚ï¼Œå®ƒå·²ç¶“å¯ä»¥å¸¶å‡ºç´°ç¯€è¦–åœ–ã€‚å„˜ç®¡å¦‚æ­¤ï¼Œåº•éƒ¨è¡¨çš„å¯¦ä½œé‚„å°šæœªå®Œæˆã€‚

é¦–å…ˆï¼Œç•¶åº•éƒ¨è¡¨å•Ÿç”¨æ™‚ï¼Œä¸æœƒé˜»æ­¢æ¸…å–®è¦–åœ–èˆ‡ä½¿ç”¨è€…äº’å‹•ï¼Œå¯¦éš›ä¸Šæ¸…å–®è¦–åœ–æ‡‰è©²è®Šæš—ï¼Œä»¥è¡¨ç¤ºå®ƒä½æ–¼ä¸‹é¢ä¸€å±¤ã€‚

ç‚ºäº†å¯¦ä½œå®ƒï¼Œæˆ‘å€‘å¯ä»¥å»ºç«‹ä¸€å€‹ç©ºè¦–åœ–ï¼Œä¸¦å°‡å®ƒæ”¾åœ¨æ¸…å–®è¦–åœ–èˆ‡ç´°ç¯€è¦–åœ–ä¹‹é–“ã€‚åœ¨Â `ContentView.swift`Â æª”ä¸­æ’å…¥ä¸‹åˆ—çš„ç¨‹å¼ç¢¼ä¾†å»ºç«‹ç©ºè¦–åœ–ï¼š

```swift
struct BlankView : View {

    var bgColor: Color

    var body: some View {
        VStack {
            Spacer()
        }
        .frame(minWidth: 0, maxWidth: .infinity, minHeight: 0, maxHeight: .infinity)
        .background(bgColor)
        .edgesIgnoringSafeArea(.all)
    }
}
```

æ¥ä¸‹ä¾†ï¼Œæ›´æ–°Â `if`Â èªå¥å¦‚ä¸‹ï¼š

```swift
if showDetail {

    BlankView(bgColor: .black)
            .opacity(0.5)
            .onTapGesture {
                self.showDetail = false
            }

    if let selectedRestaurant = selectedRestaurant {
        RestaurantDetailView(restaurant: selectedRestaurant)
            .transition(.move(edge: .bottom))
    }
}
```

é¡¯ç¤ºç´°ç¯€è¦–åœ–æ™‚ï¼Œæˆ‘å€‘åœ¨å…¶ä¸‹æ–¹æ”¾ç½®ä¸€å€‹ç©ºè¦–åœ–ã€‚ç©ºè¦–åœ–æœƒå¡«æ»¿ç‚ºé»‘è‰²åŠåŠé€æ˜ï¼Œé€™å°‡æœƒé˜»æ­¢ä½¿ç”¨è€…èˆ‡æ¸…å–®è¦–åœ–é€²è¡Œäº’å‹•ï¼Œä½†å°‡å®ƒå€‘ä¿ç•™åœ¨åŸæœ¬çš„å…§å®¹ä¸­ã€‚æˆ‘å€‘é‚„å°‡é»æ“Šæ‰‹å‹¢è­˜åˆ¥å™¨åŠ åˆ°ç©ºè¦–åœ–ï¼Œä»¥è®“ä½¿ç”¨è€…é»æ“Šç©ºç™½å€åŸŸæ™‚è§£é™¤ç´°ç¯€è¦–åœ–ã€‚

# ****åŠ å…¥å‹•ç•«****

å®ƒæ›´æ¥è¿‘æœ€çµ‚æˆæœäº†ï¼Œä¸éæˆ‘å€‘é‚„æœ‰ä¸€äº›äº‹æƒ…éœ€è¦æ³¨æ„ï¼Œä½ æ˜¯å¦æ³¨æ„åˆ°ç´°ç¯€è¦–åœ–çš„è½‰å ´æ²’æœ‰å‹•ç•«å‘¢ï¼Ÿç•¶æˆ‘å€‘æœ‰äº†Â `.transition`ä¿®é£¾å™¨ï¼Œåªæœ‰ç•¶æˆ‘å€‘å°‡å®ƒèˆ‡å‹•ç•«é…å°æ™‚ï¼Œè½‰å ´æ‰æœƒå‹•æ…‹é¡¯ç¤ºã€‚

å› æ­¤ï¼Œå›åˆ°Â `RestaurantDetailView.swift`ï¼Œä¸¦å°‡Â `.animation`Â ä¿®é£¾å™¨åŠ å…¥Â `VStack`ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š

```swift
VStack {
    ...
}
.offset(y: geometry.size.height/2)
.animation(.interpolatingSpring(stiffness: 200.0, damping: 25.0, initialVelocity: 10.0))
.edgesIgnoringSafeArea(.all)
```

åœ¨ç¨‹å¼ç¢¼ä¸­ï¼Œæˆ‘å€‘ä½¿ç”¨Â `interpolatingSpring`Â å‹•ç•«ï¼Œå‰›æ€§ï¼ˆstiffness ï¼‰ã€é˜»å°¼ï¼ˆdamping ï¼‰ èˆ‡åˆé€Ÿåº¦ï¼ˆinitial velocity ï¼‰çš„å€¼æ˜¯å¯ä»¥æ›´æ”¹çš„ã€‚ä½ å¯ä»¥ä½¿ç”¨é€™äº›å€¼ä¾†æ‰¾åˆ°é©åˆä½ çš„App çš„æœ€ä½³å‹•ç•«ã€‚

æ­¤å¤–ï¼Œæˆ‘é‚„æƒ³åœ¨ç´°ç¯€è¦–åœ–ä¸­åŠ å…¥ä¸€å€‹ç²¾å·§çš„å‹•ç•«ï¼Œå¦‚æ­¤ç•¶æˆ‘å€‘å¸¶å‡ºç´°ç¯€è¦–åœ–æ™‚ï¼Œå®ƒæœƒç¨å¾®å‘ä¸Šç§»å‹•ã€‚å›åˆ°`ContentView.swift`ï¼Œåœ¨å°è¦½è¦–åœ–ä¸­åŠ å…¥Â `.offset`Â èˆ‡Â `.animation`ä¿®é£¾å™¨ï¼š

```swift
NavigationView {
    List {
        ...
    }

    .navigationBarTitle("Restaurants")
}
.offset(y: showDetail ? -100 : 0)
.animation(.easeOut(duration: 0.2))
```

ç¾åœ¨ï¼Œåœ¨é è¦½ç•«å¸ƒä¸­å†æ¬¡åŸ·è¡Œé€™å€‹ Appã€‚ç•¶é¡¯ç¤ºç´°ç¯€è¦–åœ–æ™‚ï¼Œä½ æ‡‰è©²æœƒçœ‹åˆ°ä¸€å€‹ä¸éŒ¯çš„å‹•ç•«æ•ˆæœã€‚

# ****åŠ å…¥æ‰‹å‹¢æ”¯æ´****

ç¾åœ¨ï¼Œæˆ‘å€‘æœ‰äº†ä¸€å€‹æœªå®Œæˆçš„åº•éƒ¨è¡¨ï¼Œä¸‹ä¸€æ­¥æ˜¯ä½¿å®ƒèƒ½åœ¨æ”¯æ´æ‰‹å‹¢çš„æƒ…æ³ä¸‹å±•é–‹ã€‚å¦‚æœ¬ç« é–‹é ­æ‰€è¿°ï¼Œä½¿ç”¨è€…å¯ä»¥å‘ä¸Šæ»‘å‹•è¦–åœ–ä¾†å±•é–‹å®ƒï¼Œæˆ–æ˜¯å‘ä¸‹æ»‘å‹•è¦–åœ–ä¾†æœ€å°åŒ–ã€‚

ç”±æ–¼ä½ å·²ç¶“åœ¨å‰ä¸€ç« ä¸­å­¸éæ‹–æ›³æ‰‹å‹¢çš„å·¥ä½œåŸç†ï¼Œæˆ‘å€‘æœƒæ‡‰ç”¨é¡ä¼¼çš„æŠ€è¡“ä¾†å»ºç«‹å±•é–‹å¼ç´°ç¯€è¦–åœ–ã€‚ä¸éï¼Œé€™å€‹å±•é–‹å¼åº•éƒ¨è¡¨çš„æ‹–æ›³æ‰‹å‹¢çš„å¯¦ä½œæœƒæ¯”ä»¥å‰æ›´åŠ è¤‡é›œã€‚

åœ¨Â `RestaurantDetailView.swift`Â ä¸­ï¼Œé¦–å…ˆå®šç¾©ä¸€å€‹åˆ—èˆ‰ä¾†è¡¨ç¤ºæ‹–æ›³ç‹€æ…‹ï¼š

```swift
enum DragState {
    case inactive
    case pressing
    case dragging(translation: CGSize)

    var translation: CGSize {
        switch self {
        case .inactive, .pressing:
            return .zero
        case .dragging(let translation):
            return translation
        }
    }

    var isDragging: Bool {
        switch self {
        case .pressing, .dragging:
            return true
        case .inactive:
            return false
        }
    }

}
```

å¦å¤–ï¼Œå®£å‘Šä¸€å€‹æ‰‹å‹¢ç‹€æ…‹è®Šæ•¸ä¾†è¿½è¹¤æ‹–æ›³ï¼Œä»¥åŠå®£å‘Šä¸€å€‹ç‹€æ…‹è®Šæ•¸ä¾†å„²å­˜åº•éƒ¨è¡¨çš„ä½ç½®åç§»é‡ï¼š

```swift
@GestureState private var dragState = DragState.inactive
@State private var positionOffset: CGFloat = 0.0
```

è¦è­˜åˆ¥æ‹–æ›³ï¼Œæˆ‘å€‘å¯ä»¥å°‡Â `.gesture`Â ä¿®é£¾å™¨åŠ åˆ°Â `VStack`ï¼š

```swift
.gesture(DragGesture()
    .updating(self.$dragState, body: { (value, state, transaction) in
        state = .dragging(translation: value.translation)
        })
)
```

åœ¨updating å‡½æ•¸ä¸­ï¼Œæˆ‘å€‘åªä½¿ç”¨æœ€æ–°çš„æ‹–æ›³è³‡æ–™ä¾†æ›´æ–°Â `dragState`Â å±¬æ€§ã€‚

æœ€å¾Œï¼Œåƒé€™æ¨£ä¿®æ”¹Â `VStack`Â çš„Â `.offset`Â ä¿®é£¾å™¨ä¾†ç§»å‹•ç´°ç¯€è¦–åœ–ï¼š

```swift
.offset(y: geometry.size.height/2 + self.dragState.translation.height + self.positionOffset)
```

åœ¨è¨ˆç®—åç§»é‡æ™‚ï¼Œå°‡è€ƒæ…®åˆ°æ‹–æ›³çš„ä½ç§»èˆ‡ä½ç½®åç§»é‡ï¼Œè€Œä¸æ˜¯å›ºå®šå€¼ï¼Œé€™å°±æ˜¯æˆ‘å€‘å¦‚ä½•å•Ÿç”¨ç´°ç¯€è¦–åœ–ä¾†æ”¯æ´æ‹–æ›³æ‰‹å‹¢çš„æ–¹å¼ã€‚

å¦‚æœä½ åœ¨é è¦½ç•«å¸ƒä¸­æ¸¬è©¦ç´°ç¯€è¦–åœ–ï¼Œå‰‡æ‡‰è©²èƒ½å¤ æ‹–æ›³æ©«åˆ—ä¾†æ»‘å‹•è¦–åœ–ã€‚ä¸éï¼Œé€éæ‹–æ›³å…§å®¹è¦–åœ–ä¾†å‘ä¸Š/ å‘ä¸‹æ»‘å‹•è¦–åœ–å¹¾ä¹æ˜¯ä¸å¯èƒ½çš„ã€‚

ç‚ºä»€éº¼æˆ‘å€‘ä¸èƒ½æ‹–æ›³å…§å®¹è¦–åœ–ä¾†å±•é–‹ç´°ç¯€è¦–åœ–å‘¢ï¼Ÿ

å¦‚æœä½ é‚„è¨˜å¾—çš„è©±ï¼Œç´°ç¯€è¦–åœ–çš„å…§å®¹éƒ¨åˆ†è¢«åµŒå…¥åˆ°æ»¾å‹•è¦–åœ–ä¸­ã€‚å› æ­¤ï¼Œæˆ‘å€‘å¯¦éš›ä¸Šæœ‰å…©å€‹æ‰‹å‹¢è­˜åˆ¥å™¨ï¼šä¸€å€‹å…§å»ºåœ¨æ»¾å‹•è¦–åœ–ä¸­ï¼Œå¦ä¸€å€‹æ˜¯æˆ‘å€‘åŠ å…¥çš„æ‹–æ›³æ‰‹å‹¢ã€‚

é‚£éº¼ï¼Œ æˆ‘å€‘è©²å¦‚ä½•è§£æ±ºå‘¢ï¼Ÿ ä¸€ç¨®æ–¹å¼æ˜¯ç¦ç”¨ä½¿ç”¨è€…èˆ‡æ»¾å‹•è¦–åœ–çš„äº’å‹•ã€‚ä½ å¯ä»¥å°‡Â `.disabled`Â ä¿®é£¾å™¨åŠ å…¥åˆ°æ»¾å‹•è¦–åœ–ï¼Œä¸¦è¨­å®šå…¶å€¼ç‚ºÂ `true`ï¼š

```swift
.disabled(true)
```

ç•¶ä½ å°‡é€™å€‹ä¿®é£¾å™¨åŠ åˆ°Â `ScrollView`Â å¾Œï¼Œå°±å¯ä»¥é€éæ‹–æ›³å…§å®¹éƒ¨åˆ†ä¾†å‘ä¸Š/ å‘ä¸‹æ»‘å‹•ç´°ç¯€è¦–åœ–ã€‚

ä¸éï¼Œæ¥ä¸‹ä¾†çš„å•é¡Œæ˜¯ï¼Œç•¶ç¦ç”¨æ»¾å‹•è¦–åœ–å¾Œï¼Œä½¿ç”¨è€…ç„¡æ³•èˆ‡æ»¾å‹•è¦–åœ–äº’å‹•ï¼Œé€™è¡¨ç¤ºä½¿ç”¨è€…ä¸èƒ½æŸ¥çœ‹é¤å»³çš„å…¨éƒ¨å…§å®¹ï¼Œå› æ­¤æˆ‘å€‘é‚„æ˜¯éœ€è¦ä½¿å…§å®¹éƒ¨åˆ†å¯ä»¥æ»¾å‹•ã€‚

ç”¨è€…ä¸èƒ½æŸ¥çœ‹é¤å»³çš„å…¨éƒ¨å…§å®¹ï¼Œå› æ­¤æˆ‘å€‘é‚„æ˜¯éœ€è¦ä½¿å…§å®¹éƒ¨åˆ†å¯ä»¥æ»¾å‹•ã€‚

é¡¯ç„¶çš„ï¼Œæˆ‘å€‘éœ€è¦æ‰¾åˆ°ä¸€ç¨®æ–¹å¼ä¾†æ§åˆ¶æ»¾å‹•è¦–åœ–çš„å•Ÿç”¨ã€‚ä¸€å€‹ç°¡å–®çš„è§£æ±ºæ–¹æ¡ˆæ˜¯ï¼Œç•¶æ»¾å‹•è¦–åœ–åœ¨åŠé–‹ç‹€æ…‹ç¦ç”¨å®ƒã€‚åœ¨ç´°ç¯€è¦–åœ–å…¨éƒ¨é–‹å•Ÿå¾Œï¼Œæˆ‘å€‘å†æ¬¡å•Ÿç”¨æ»¾å‹•è¦–åœ–ã€‚

ç›®å‰å¯¦ä½œçš„å¦ä¸€å€‹å•é¡Œæ˜¯ï¼Œå³ä½¿ä½¿ç”¨è€…å°‡è¦–åœ–ä¸€ç›´æ»‘å‹•åˆ°ç‹€æ…‹åˆ—ï¼Œç´°ç¯€è¦–åœ–ä¹Ÿç„¡æ³•ä¿æŒå®Œå…¨é–‹å•Ÿã€‚æ‹–æ›³çµæŸå¾Œï¼Œå®ƒæœƒåå½ˆå›åŠé–‹ç‹€æ…‹ã€‚åä¹‹ï¼Œå³ä½¿ä½ å°‡ç´°ç¯€è¦–åœ–å‘ä¸‹æ»‘å‹•åˆ°è¢å¹•å°¾ç«¯ï¼Œä¹Ÿç„¡æ³•é—œé–‰ç´°ç¯€è¦–åœ–ã€‚

æˆ‘å€‘è©²å¦‚ä½•è™•ç†é€™äº›å•é¡Œå‘¢ï¼Ÿ

## ****åŠé–‹ç‹€æ…‹æ™‚çš„è™•ç†æ–¹å¼****

æˆ‘å€‘å…ˆè™•ç†åœ¨åŠé–‹ç‹€æ…‹æ™‚æœƒç¢°åˆ°çš„å•é¡Œã€‚ç´°ç¯€è¦–åœ–å¸¶å‡ºæ™‚æœƒä»¥åŠé–‹ä½œç‚ºé è¨­ç‹€æ…‹ï¼Œé€™å€‹ç‹€æ…‹ä¸‹æœƒå‡ºç¾ä»¥ä¸‹å…©ç¨®æƒ…æ³ï¼š

1. ä½¿ç”¨è€…é¸æ“‡å‘ä¸Šæ»¾å‹•è¦–åœ–è®“å®ƒå…¨é–‹ï¼Œä¸éä½¿ç”¨è€…å¯èƒ½æœƒå‘ä¸Šæ‹–æ›³ä¸€é»ï¼Œæ¥è‘—å‘ä¸‹æ‹–æ›³ä¾†å–æ¶ˆå‹•ä½œã€‚
2. å¦å¤–ä¸€ç¨®ç‹€æ³æ˜¯ï¼Œä½¿ç”¨è€…ç›´æ¥å‘ä¸‹æ»¾å‹•ä»¥é—œé–‰è¦–åœ–ï¼Œæ­¤å¤–ï¼Œä¹Ÿæœ‰å¯èƒ½è¿”å›æ‹–æ›³ä¾†å–æ¶ˆé—œé–‰å‹•ä½œã€‚

å¾é€™äº›å ´æ™¯ä¸­å¯ä»¥çœ‹å‡ºï¼Œé™¤äº†è¿½è¹¤æ‹–æ›³åç§»é‡ä¹‹å¤–ï¼Œæˆ‘å€‘é‚„éœ€è¦ä¸€äº›ç•Œé™å€¼ï¼ˆthresholdï¼‰ ä¾†æ§åˆ¶è¦–åœ–çš„é–‹å•Ÿå’Œé—œé–‰

ä¸Šåœ–é¡¯ç¤ºäº†åœ¨åŠé–‹ç‹€æ…‹æ™‚ï¼Œæˆ‘å€‘å°‡è¦å®šç¾©çš„ç•Œé™å€¼ï¼š

- **ç•Œé™å€¼ #1**Â - ç•¶æ‹–æ›³è¶…éç•Œé™å€¼ï¼Œç´°ç¯€è¦–åœ–å°±æœƒå®Œå…¨é–‹å•Ÿã€‚
- **ç•Œé™å€¼ #2**Â - ç•¶æ‹–æ›³ç§»å‹•ä½æ–¼ç•Œé™å€¼ï¼Œç´°ç¯€è¦–åœ–å°‡æœƒé—œé–‰ã€‚

ç¾åœ¨ï¼Œä½ æ‡‰è©²çŸ¥é“äº†åŠé–‹ç‹€æ…‹èˆ‡å…¨é–‹ç‹€æ…‹çš„å·¥ä½œåŸç†ï¼Œè®“æˆ‘å€‘é€²å…¥ç¨‹å¼ç¢¼éƒ¨åˆ†ã€‚é¦–å…ˆï¼Œæˆ‘å€‘åœ¨`RestaurantDetailView.swift`Â å®£å‘Šå¦ä¸€å€‹åˆ—èˆ‰ä¾†è¡¨ç¤ºé€™å…©ç¨®è¦–åœ–ç‹€æ…‹ï¼š

```swift
enum ViewState {
    case full
    case half
}
```

åœ¨Â `RestaurantDetailView`ä¸­ï¼Œå®£å‘Šå¦ä¸€å€‹ç‹€æ…‹å±¬æ€§ä¾†å„²å­˜ç›®å‰çš„è¦–åœ–ç‹€æ…‹ã€‚é è¨­ä¸Šï¼Œå®ƒè¨­å®šç‚ºåŠé–‹ç‹€æ…‹ï¼š

```swift
@State private var viewState = ViewState.half
```

å¦å¤–ï¼Œç‚ºäº†è§£é™¤è¦–åœ–æœ¬èº«ï¼Œæˆ‘å€‘éœ€è¦Â `ContentView`Â å‘æˆ‘å€‘å‚³é€å…¶ç‹€æ…‹è®Šæ•¸çš„ç¶å®šï¼Œå› æ­¤å®£å‘ŠÂ `isShow`Â è®Šæ•¸å¦‚ä¸‹ï¼š

```swift
@Binding var isShow: Bool
```

> é¡¯ç„¶çš„ï¼Œæˆ‘å€‘éœ€è¦æ‰¾åˆ°ä¸€ç¨®æ–¹æ³•ä¾†æ§åˆ¶æ»¾å‹•è¦–åœ–çš„å•Ÿç”¨ï¼Œä¸€å€‹ç°¡å–®çš„è§£æ±ºæ–¹æ¡ˆæ˜¯ç•¶å®ƒè™•æ–¼åŠé–‹ç‹€æ…‹æ™‚ï¼Œç¦ç”¨æ»¾å‹•è¦–åœ–ã€‚è€Œåœ¨ç´°ç¯€è¦–åœ–å®Œå…¨é–‹å•Ÿå¾Œï¼Œæˆ‘å€‘å†æ¬¡å•Ÿç”¨æ»¾å‹•è¦–åœ–
> 

æ¥ä¸‹ä¾†ï¼Œæˆ‘å€‘ä¿®æ­£æ»¾å‹•è¦–åœ–çš„æ»¾å‹•å•é¡Œã€‚å°‡Â `.disabled`Â ä¿®é£¾å™¨åŠ åˆ°Â `ScrollView`ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š

```swift
.disabled(self.viewState == .half)
```

ç•¶ç´°ç¯€è¦–åœ–åœ¨åŠé–‹ç‹€æ…‹ï¼Œæˆ‘å€‘é—œé–‰æ»¾å‹•è¦–åœ–çš„ä½¿ç”¨è€…äº’å‹•è¡Œç‚ºã€‚

ç¾åœ¨ï¼Œæˆ‘å€‘ä¾†å¯¦ä½œå‰›æ‰è¨è«–çš„ç•Œé™å€¼ã€‚æ­£å¦‚ä½ ä¹‹å‰æ‰€å­¸åˆ°çš„ï¼Œç•¶æ‹–æ›³çµæŸæ™‚ï¼ŒSwiftUI æœƒè‡ªå‹•å‘¼å«Â `onEnded`Â å‡½æ•¸ã€‚å› æ­¤ï¼Œæˆ‘å€‘å°‡è™•ç†æ­¤å‡½æ•¸ä¸­çš„ç•Œé™å€¼ï¼Œç¾åœ¨æ›´æ–°Â `.gesture`Â ä¿®é£¾å™¨å¦‚ä¸‹ï¼š

```swift
.gesture(DragGesture()
    .updating(self.$dragState, body: { (value, state, transaction) in
        state = .dragging(translation: value.translation)
        })
    .onEnded({ (value) in

        if self.viewState == .half {
            // ç•Œé™å€¼ #1
            // å‘ä¸Šæ»‘å‹•ï¼Œç•¶å®ƒè¶…éç•Œé™å€¼æ™‚
            // é€éæ›´æ–°ä½ç½®åç§»é‡ä¾†è®Šæ›´è¦–åœ–ç‹€æ…‹ç‚ºå…¨éƒ¨é–‹å•Ÿ
            if value.translation.height < -geometry.size.height * 0.25 {
                self.positionOffset = -geometry.size.height/2 + 50
                self.viewState = .full
            }

            // ç•Œé™å€¼ #2
            // å‘ä¸‹æ»‘å‹•ï¼Œç•¶å®ƒé€šéç•Œé™å€¼
                      // é€éè¨­å®šisShow ç‚º false ä¾†é—œé–‰è¦–åœ–
            if value.translation.height > geometry.size.height * 0.3 {
                self.isShow = false
            }
        }

    })
)
```

æˆ‘ä½¿ç”¨è¢å¹•é«˜åº¦ä¾†è¨ˆç®—ç•Œé™å€¼ã€‚èˆ‰ä¾‹è€Œè¨€ï¼Œç•Œé™å€¼ #2 è¨­å®šç‚ºè¢å¹•é«˜åº¦çš„ä¸‰åˆ†ä¹‹ä¸€ï¼Œé€™åªæ˜¯ä¸€å€‹ç¯„ä¾‹å€¼ï¼Œä½ å¯ä»¥æ ¹æ“šä½ çš„éœ€è¦ä¿®æ”¹å®ƒã€‚

å¦‚æœä½ éœ€è¦é€²ä¸€æ­¥äº†è§£ç¨‹å¼ç¢¼çš„å·¥ä½œåŸç†ï¼Œè«‹åƒè€ƒç¨‹å¼ç¢¼æ³¨é‡‹ã€‚

ç”±æ–¼æˆ‘å€‘åœ¨Â `RestaurantDetailView`Â ä¸­åŠ å…¥ä¸€å€‹ç¶å®šè®Šæ•¸ï¼Œå› æ­¤å¿…é ˆæ›´æ–°Â `RestaurantDetailView_Previews`Â çš„ç¨‹å¼ç¢¼ï¼š

```swift
struct RestaurantDetailView_Previews: PreviewProvider {
    static var previews: some View {
        RestaurantDetailView(restaurant: restaurants[0], isShow: .constant(true))
            .background(Color.black.opacity(0.3))
            .edgesIgnoringSafeArea(.all)
    }
}
```

åŒæ¨£çš„ï¼Œä½ éœ€è¦å›åˆ°Â `ContentView.swift`ï¼Œä¾†ä¾ç…§ä¸‹åˆ—çš„å…§å®¹é€²è¡Œè®Šæ›´ï¼š

```swift
if let selectedRestaurant = selectedRestaurant {
    RestaurantDetailView(restaurant: selectedRestaurant, isShow: $showDetail)
        .transition(.move(edge: .bottom))
}
```

ç¶“éä¸€ç•ªåŠªåŠ›å¾Œï¼Œæ˜¯æ™‚å€™æ¸¬è©¦å±•é–‹å¼ç´°ç¯€è¦–åœ–äº†ã€‚åœ¨æ¨¡æ“¬å™¨æˆ–é è¦½ç•«å¸ƒä¸­åŸ·è¡Œé€™å€‹ Appï¼Œä½ å°‡èƒ½å¤ å‘ä¸‹æ‹–æ›³ä¾†é—œé–‰ç´°ç¯€è¦–åœ–ï¼Œæˆ–å‘ä¸Šæ‹–æ›³ä¾†å±•é–‹å®ƒã€‚

# ****å…¨é–‹ç‹€æ…‹æ™‚çš„è™•ç†****

ç¾åœ¨ä½ æ‡‰è©²èƒ½å¤ å‘ä¸‹æ‹–æ›³ç´°ç¯€è¦–åœ–ä¾†é—œé–‰å®ƒï¼Œæˆ–å°‡è¦–åœ–å‘ä¸Šæ‹–æ›³ä¾†å±•é–‹ã€‚ç›®å‰çš„åŠŸèƒ½é‹ä½œæ­£å¸¸ï¼Œä¸éä¸»è¦å•é¡Œåœ¨æ–¼è¦–åœ–å®Œå…¨å±•é–‹æ™‚ï¼Œæ»¾å‹•è¦–åœ–æœƒæ“‹ä½åˆ°æˆ‘å€‘çš„æ‹–æ›³æ‰‹å‹¢ï¼Œæ›å¥è©±èªªï¼Œä½ å¯ä»¥æ»¾å‹•å…§å®¹ï¼Œä½†æ˜¯å»ç„¡æ³•å°‡è¦–åœ–é€€å›åŠé–‹ç‹€æ…‹ã€‚

åœ¨ä¿®æ­£é€™å€‹æ»¾å‹•å•é¡Œä¹‹å‰ï¼Œæˆ‘å€‘å…ˆä¿®æ­£å¹¾å€‹ç´°ç¯€è¦–åœ–çš„å°å•é¡Œã€‚ä½ å¯èƒ½æœƒæ³¨æ„åˆ°å³ä½¿ç´°ç¯€è¦–åœ–åœ¨å®Œå…¨å±•é–‹çš„ç‹€æ…‹ä¸‹ï¼Œå»ä¸èƒ½æ»¾å‹•è‡³æè¿°å…§å®¹çš„æœ€å°¾ç«¯è™•ï¼Œè¦è§£æ±ºé€™å€‹å•é¡Œï¼Œé–‹å•ŸÂ `RestaurantDetailView.swift`ï¼Œç„¶å¾Œæ›´æ–°Â `DetailInfoView`Â ä¾†å‘ˆç¾é¤å»³çš„æè¿°ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š

```swift
DetailInfoView(icon: nil, info: self.restaurant.description)
    .padding(.top)
    .padding(.bottom, 100)
```

æˆ‘å€‘åªæ˜¯åŠ ä¸Šä¸€å€‹Â `.padding`Â ä¿®é£¾å™¨ä¾†å¢åŠ ç©ºé–“ï¼Œé€™å¯ä»¥è®“ä½ æ»¾å‹•å®Œæ•´å€‹æè¿°å…§å®¹ã€‚

å›åˆ°æ»¾å‹•çš„å•é¡Œã€‚æˆ‘å€‘å¦‚ä½•è®“ä½¿ç”¨è€…ä½¿ç”¨æ‹–æ›³æ‰‹å‹¢æ»¾å‹•å…§å®¹ä¸¦å¯ä»¥å°‡è¦–åœ–é€€å›è‡³åŠé–‹ç‹€æ…‹å‘¢ï¼Ÿä½¿ç”¨è€…å°‡è¦–åœ–å‘ä¸Šæ‹–æ›³ä¾†æ­é–‹å…§å®¹ï¼Œåä¹‹ï¼Œä½¿ç”¨è€…æƒ³é—œé–‰ç´°ç¯€è¦–åœ–æ™‚æœƒç¹¼çºŒå°‡è¦–åœ–å‘ä¸‹æ‹–æ›³ã€‚ç¾åœ¨ï¼Œä½ å¯ä»¥å‘ä¸‹æ‹–æ›³æ»¾å‹•è¦–åœ–ï¼Œä¸éå•é¡Œæ˜¯ç•¶ä½ æ‰‹æŒ‡æ”¾é–‹æ™‚ï¼Œè¦–åœ–æœƒå½ˆå›ä¸Šé¢ã€‚

å› ç‚ºæ»¾å‹•è¦–åœ–æ“‹ä½äº†æˆ‘å€‘åŠ ä¸Šçš„æ‹–æ›³æ‰‹å‹¢ï¼Œæˆ‘å€‘å¿…é ˆæ‰¾åˆ°å¦å¤–ä¸€å€‹æ–¹å¼ä¾†åµæ¸¬é€™å€‹ã€Œå‘ä¸‹æ‹–æ›³ã€æ‰‹å‹¢ã€‚ä½ å·²ç¶“å­¸éå¦‚ä½•ä½¿ç”¨Â `GeometryReader`Â ä¾†æ¸¬é‡è¦–åœ–çš„å¤§å°ï¼Œæˆ‘å€‘å¯ä»¥åˆ©ç”¨å®ƒä¾†æ‰¾åˆ°å¦‚åœ– 8.13 æ‰€ç¤ºçš„æ»¾å‹•åç§»é‡ï¼ˆscroll offsetï¼‰

è©¦è‘—å°‡ä¸‹é¢é€™æ®µç¨‹å¼åŠ åœ¨Â `ScrollView`Â å…§ï¼Œä¸¦ç½®æ–¼Â `TitleBar()`Â ä¸Šæ–¹ï¼š

```swift
GeometryReader { scrollViewProxy in
    Text("\(scrollViewProxy.frame(in: .named("scrollview")).minY)")
}
.frame(height: 0)
```

é€™ä¸æ˜¯æœ€å¾Œçš„ç¨‹å¼ç¢¼ï¼Œæˆ‘åªæ˜¯æƒ³è¦å‘Šè¨´ä½ å¦‚ä½•ä½¿ç”¨Â `GeometryReader`Â ä¾†è®€å–æ»¾å‹•åç§»é‡ã€‚`GeometryReader`Â çš„é–‰åŒ…ä¸­ï¼Œæˆ‘å€‘å¯ä»¥ä½¿ç”¨Â `scrollViewProxy`ï¼Œå‘¼å«Â `frame`Â å‡½æ•¸ä¸¦å–å¾—Â `minY`çš„å€¼ä¾†è¨ˆç®—åç§»é‡ã€‚åœ¨å‘¼å«Â `frame`Â å‡½æ•¸æ™‚ï¼Œå¿…é ˆå‚³éä½ æœŸæœ›çš„åº§æ¨™ç©ºé–“ã€‚é€™è£¡æˆ‘å€‘è‡ªå·±å®šç¾©è¦ç¯„æ»¾å‹•è¦–åœ–çš„åº§æ¨™ç©ºé–“ã€‚

ç‚ºäº†å®šç¾©è‡ªå·±çš„åº§æ¨™ç©ºé–“ï¼Œå¦‚ä¸‹ï¼ŒåŠ ä¸ŠÂ `.coordinateSpace`Â ä¿®é£¾å™¨è‡³Â `ScrollView`ï¼š

```swift
.coordinateSpace(name: "scrollview")
```

ä½ å¯èƒ½æƒ³çŸ¥é“ï¼Œç‚ºä½•æˆ‘å€‘å¿…é ˆä½¿ç”¨è‡ªå·±çš„åº§æ¨™ç©ºé–“ï¼Œè€Œéä½¿ç”¨Â `.global`Â ã€‚

# ****PreferenceKey çš„ä»‹ç´¹****

SwiftUI æ¡†æ¶æä¾›äº†ä¸€å€‹Â `PreferenceKey`Â å”å®šï¼Œå¯ä»¥è®“ä½ å¾ˆå®¹æ˜“åœ°å¾å­è¦–åœ–å‚³éè³‡æ–™è‡³å®ƒçš„çˆ¶è¦–åœ–ã€‚

ç‚ºäº†ä½¿ç”¨ä½ˆå±€åå¥½ï¼ˆpreferenceï¼‰ä¾†å‚³éæ»¾å‹•åç§»é‡ï¼Œæˆ‘å€‘å¿…é ˆå»ºç«‹ä¸€å€‹çµæ§‹ä¾†éµå¾ªÂ `PreferenceKey`å”å®šï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼Œåœ¨Â `RestaurantDetailView.swift`Â æ’å…¥ä»¥ä¸‹é€™æ®µç¨‹å¼ï¼š

```swift
struct ScrollOffsetKey: PreferenceKey {
    typealias Value = CGFloat

    static var defaultValue = CGFloat.zero

    static func reduce(value: inout Value, nextValue: () -> Value) {
        value += nextValue()
    }
}
```

é€™å€‹å”å®šæœ‰å…©å€‹å¿…è¦çš„å¯¦ä½œå…§å®¹ï¼Œé¦–å…ˆï¼Œä½ å¿…é ˆå®šç¾©é è¨­å€¼ï¼Œä»¥æˆ‘å€‘é€™å€‹å¯¦ä½œè€Œè¨€é è¨­å€¼ç‚ºé›¶ã€‚ç¬¬äºŒï¼Œä½ å¿…é ˆå¯¦ä½œÂ `reduce`Â å‡½æ•¸ä¾†å°‡æ‰€æœ‰åç§»é‡å€¼åˆä½µæˆä¸€å€‹ã€‚

æ¥ä¸‹ä¾†ï¼Œä½ å¯ä»¥ä¿®æ”¹å‰ä¸€ç¯€æ‰€å»ºç«‹çš„Â `GeometryReader`ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š

```swift
GeometryReader { scrollViewProxy in
    Color.clear.preference(key: ScrollOffsetKey.self, value: scrollViewProxy.frame(in: .named("scrollview")).minY)
}
.frame(height: 0)
```

ç¨‹å¼ä¸­ï¼Œæˆ‘å€‘å–å¾—æ»¾å‹•çš„åç§»é‡ï¼Œä¸¦å°‡è‡³å„²å­˜è‡³åå¥½éµï¼ˆpreference keyï¼‰ã€‚æˆ‘å€‘ä½¿ç”¨Â `Color.clear`Â è¦–åœ–ä¾†éš±è—è¦–åœ–ã€‚

æ¥ä¸‹ä¾†çš„å•é¡Œæ˜¯å¦‚ä½•å¾ä½ˆå±€åå¥½å–å¾—æ»¾å‹•è¦–åœ–å‘¢ï¼Ÿ

ä¸€å€‹ç°¡å–®çš„æ–¹å¼æ˜¯ä½¿ç”¨Â `.onPreferenceChange`Â ä¿®é£¾å™¨ä¾†è§€å¯Ÿå€¼çš„è®Šæ›´ã€‚ä½ å¯ä»¥åŠ ä¸Šä¿®é£¾å™¨è‡³Â `VStack`ï¼Œä¸¦ç½®æ–¼Â `.gesture`Â ä¸‹æ–¹ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š

```swift
.onPreferenceChange(ScrollOffsetKey.self) { value in
    print("\(value)")
}
```

é€™è£¡æˆ‘å€‘åªæ˜¯è¼¸å‡ºåç§»é‡çš„å€¼ã€‚åœ¨æ¨¡æ“¬å™¨åŸ·è¡Œé€™å€‹ App ï¼Œç•¶ä½ æ‹–æ›³ç´°ç¯€è¦–åœ–æ™‚ï¼Œä½ æ‡‰è©²æœƒåœ¨ä¸­æ§å°è¦‹åˆ°é€™å€‹åç§»é‡ã€‚

ç¾åœ¨ä½ æ‡‰è©²å°æ–¼ PreferenceKey çš„é‹ä½œæ–¹å¼æœ‰åŸºæœ¬è§€å¿µï¼Œæˆ‘å€‘å®Œæˆäº†é€™å€‹å¯¦ä½œï¼Œç´°ç¯€æ˜¯åœ–å¯ä»¥å›åˆ°åŠé–‹ç‹€æ…‹ã€‚

å®£å‘Šä¸€å€‹æ–°ç‹€æ…‹è®Šæ•¸ä¾†æŒçºŒè¿½è¹¤æ»¾å‹•åç§»é‡ï¼š

```swift
@State private var scrollOffset: CGFloat = 0.0
```

æ¥è‘—ï¼Œæ›´æ–°Â `.onPreferenceChange`Â ä¿®é£¾å™¨å¦‚ä¸‹ï¼š

```swift
.onPreferenceChange(ScrollOffsetKey.self) { value in
    if self.viewState == .full {
        self.scrollOffset = value > 0 ? value : 0

        if self.scrollOffset > 120 {
            self.positionOffset = 0
            self.scrollOffset = 0
            DispatchQueue.main.asyncAfter(deadline: .now() + 0.5) {
               self.viewState = .half
            }
        }
    }
}
```

ç•¶åç§»é‡æœ‰è®ŠåŒ–æ™‚ï¼Œæˆ‘å€‘æª¢æŸ¥ä»–æ˜¯å¦è¶…éæˆ‘å€‘çš„ç•Œé™å€¼ï¼ˆ ä¹Ÿå°±æ˜¯ 120 ï¼‰ï¼Œå¦‚æœè¶…éäº†ï¼Œæˆ‘å€‘è¨­å®šè¦–åœ–ç‹€æ…‹å› .half ã€‚ç¾åœ¨åŠ ä¸Šå¦ä¸€å€‹ .offset ä¿®é£¾å™¨è‡³ VStackï¼š

```swift
.offset(y: self.scrollOffset)
```

å¦å¤–åŠ ä¸Šé€™å€‹Â `.offset`Â ä¿®é£¾å™¨çš„ç›®çš„æ˜¯å°‡ç´°ç¯€è¦–åœ–å‘ä¸‹ç§»å‹•ã€‚å¦‚æœä½ åœ¨æ¨¡æ“¬å™¨åŸ·è¡Œé€™å€‹ Appï¼Œä½ æ‡‰è©²å¯ä»¥å°‡å±•é–‹å¾Œçš„è¦–åœ–é€€å›è‡³åŠé–‹ç‹€æ…‹ã€‚

# çµèª

çœ‹äº†è¨±ä¹…å¤§æ¦‚äº†è§£åˆ°ç‚ºä½•æœƒé€™éº¼åƒåŠ›äº†ï¼Œçœ‹æ˜¯çœ‹æ‡‚äº†ï¼Œä½†æ˜¯ç´°ç¯€çš„æŠ€å·§ä¸¦æ²’æœ‰å…§å»ºåœ¨è…¦è¢‹ä¸­ã€‚ä»¥è‡³æ–¼ã€Œé€™æ¨£å¯«å°±èƒ½æˆåŠŸé”åˆ°éœ€è¦çš„æ•ˆæœï¼Œä½†ç‚ºä½•è¦é€™éº¼åšä¸æ¸…æ¥šã€‚ã€æƒ³æ³•æµ®ç¾å‡ºä¾†ï¼Œæ›å¥è©±èªªå…¶å¯¦é‚„æ˜¯ä¸æ‡‚ï¼Œä¸¦ç„¡æ³•æ‡‰ç”¨åœ¨å…¶ä»–çš„å°ˆæ¡ˆã€‚